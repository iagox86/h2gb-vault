<html>
  <head>
    <script src='/static/jquery.js'></script>
    <script>
      function to_hex_string(data)
      {
        return (data.split('').map (function (c) { return (c.charCodeAt(0) < 16 ? '0' : '') + c.charCodeAt(0).toString(16); })).join(' ')
      }
      function try_disassemble(name, data_ref)
      {
        e = $('#code_' + name);
        e.html("Working...");

        $.getJSON("/disasm/x86/" + data_ref, {}, function(data) {
          e.html('');
          e.append("<table>");
          for(i in data['instructions'])
          {
            i = data['instructions'][i];

            e.append("<tr>");
            e.append("<td>0x" + i['address'].toString(16) + "</td>");
            e.append("<td>" + to_hex_string(atob(i['bytes'])) + "</td>");
            e.append("<td>" + i['name'] + "</td>");
            e.append("<td>" + i['args'].join(', ') + "</td>");
          }
          e.append("</table>");

          e.append("<input type='button' onClick=\"$('#json_" + name + "').toggle()\" value='Toggle raw'>");
          e.append("<pre id='json_" + name + "' style='display: none;'>" + JSON.stringify(data, null, 4) + "</pre>");
        })
      }

      function load(id)
      {
        $('#list_container').hide();
        $('#top_container').show();

        out = $('#top_container');

        /* Clear it. */
        out.html("<p><a href='#' onClick='show_list()'>Show files</a></p>");

        /* Let the user exit this view. */
        out.append('Working...');

        /* TODO: This is going away. */
        $.getJSON("/parse/" + id, {}, function(data) {
          out.html("<p><a href='#' onClick='show_list()'>Show files</a></p>");
          out.append("<p>Format: " + data['format'] + "</p>");

          out.append("<p>Header:</p>");
          out.append("<table>");
          out.append("<tr><th width='200' style='text-align: left;'>Name</th><th width='500' style='text-align: left;'>Value</th></tr>");

          if(typeof data['header']['base'] != "undefined")
            out.append("<tr><td>Base address</td><td>0x" + data['header']['base'].toString(16) + "</td></tr>");
          out.append("<tr><td>Entrypoint</td><td>0x" + data['header']['entrypoint'].toString(16) + "</td></tr>");
          out.append("</table>");

          out.append("<h1>Imports</h1>");
          out.append("<p><input type='button' value='Toggle imports' onClick='$(\"#imports\").toggle();' /></p>");

          imports = "";
          imports += "<table id='imports' style='display: none;'>";
          imports += "<tr><th width='200' style='text-align: left;'>Library</th><th width='500' style='text-align: left;'>Hint</th><th width='500' style='text-align: left;'>Target</th></tr>";
          for(i in data['imports'])
          {
            for(j in data['imports'][i])
            {
              imports += "<tr>";
              imports += "<td>" + i + "</td>";
              if(data['imports'][i][j]['hint'])
                imports += "<td>0x" + data['imports'][i][j]['hint'].toString(16) + "</td>";
              if(data['imports'][i][j]['target'])
                imports += "<td>" + data['imports'][i][j]['target'].toString(16) + "</td>";
              imports += "</tr>";
            }
          }
          imports += "</table>";
          imports += "</div>";

          out.append(imports);

          out.append("<h1>Exports</h1>");
          out.append("<p><input type='button' value='Toggle exports' onClick='$(\"#exports\").toggle();' /></p>");
          exports = "";
          exports += "<table id='exports' style='display: none;'>";
            exports += "<tr><th width='200' style='text-align: left;'>Address</th><th width='200' style='text-align: left;'>Ordinal</th><th width='500' style='text-align: left;'>Name</th></tr>";
          for(e in data['exports'])
          {
            e = data['exports'][e];
            exports += "<tr>";
            exports += "<td>0x" + e['address'].toString(16) + "</td>";
            exports += "<td>" + e['ordinal'] + "</td>";
            exports += "<td>" + e['name'] + "</td>";
            exports += "</tr>";
          }
          exports += "</table>";
          exports += "</div>";

          out.append(exports);

          for(section in data['sections'])
          {
            section = data['sections'][section];
            name = section['name'];
            name = name.replace(/[^a-zA-Z0-9_]/g, '_');

            out.append("<p>Section " + section['name'] + "</p>");
            out.append("<div id='code_" + name + "'><input type='button' value='Try to disassemble' onClick='try_disassemble(\"" + name + "\", \"" + section['data_ref'] + "\")'></p>");
            out.append("<hr>");

          }

          out.append("<hr>");
          out.append("<input type='button' onClick=\"$('#json').toggle()\" value='Toggle'>");
          $('#top_container').append("<div id='json'><pre>" + JSON.stringify(data, null, 4) + "</pre></div>");
        });
      }

      function show_list()
      {
        $('#list_container').show();
        $('#top_container').hide();
        $.getJSON("/list", {}, function(data) {
          for(key in data) {
            value = data[key];
            $('#list').append("<li><a href='#" + value + "' onClick=load('" + value + "');>" + value + "</a></li>");
          }
        });
      }

      $(document).ready(function() {
        if(document.location.hash == "" || document.location.hash == '#')
        {
          show_list();
        }
        else
        {
          load(document.location.hash.substring(1));
        }
      });

    </script>
  </head>

  <body>
    <div id="list_container" style="display: none;">
      <p>You can upload files here; you should get the id back as JSON, which will then appear in the list (yeah, that's ugly, but that's what you get for now :) )</p>
      <form action='/upload_html' method='post' enctype='multipart/form-data'>
        <p><input type='file' name='file' /></p>
        <p>Comment <input type='text' name='comment'></p>
        
        <input type='submit' name='upload' />
      </form>
      <ul id="list"></ul>
    </div>
    <div id="top_container" style="display: none;">
    </div>
  </body>
</html>
